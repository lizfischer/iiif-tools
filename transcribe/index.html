<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Re-Pen</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">


    <link rel="stylesheet" href="node_modules/leaflet/dist/leaflet.css">
    <script src="node_modules/leaflet/dist/leaflet.js"></script>
    <script src="node_modules/leaflet-iiif/leaflet-iiif.js"></script>
    <script src="node_modules/leaflet-path-drag/dist/L.Path.Drag.js"></script>

    <link rel="stylesheet" href="node_modules/leaflet-mouse-position/L.Control.MousePosition.css">
    <script src="node_modules/leaflet-mouse-position/L.Control.MousePosition.js"></script>

    <link rel="stylesheet" href="node_modules/leaflet-toolbar/dist/leaflet.toolbar.css">
    <script src="node_modules/leaflet-toolbar/dist/leaflet.toolbar.js"></script>

    <script src="node_modules/leaflet-singleclick.js"></script>


</head>
<body>
    <div class="fullscreen">
        <button onclick="doStuff()">Do Stuff</button>
        <button onclick="finishColumns()">Finish Columns</button>
        <button onclick="finishRows()">Finish Rows for Column</button>
        <button onclick="done()">Done</button>
        <div id="viewer"></div>
    </div>
<style>
    body, html,.fullscreen{
        width: 100%;
        height:100%;
        margin: 0;
        padding: 0;
    }
    #viewer{
        width:100%;
        height:100%;
    }
    .fas {
        color: black;
    }
    .active-button {
        background-color: dodgerblue; !important;
    }
</style>

<script type="text/javascript">
    function doStuff(){
        //console.log(tiles._map.getSize(), tiles._getBounds())
        console.log(viewer._layers)
    }

    function finishColumns(){
        var guides = viewer._layers;
        var yvals = [];
        for (id in linesV){
            console.log(linesV[id]);
            var guide = guides.linesV[id];
            var latlngs = guide._latlngs;
            //yvals.push(guides[id]._latlngs[0].lng);
        }
        console.log(yvals)
    }
    function finishRows(){

    }
    function done(){

    }

    var viewer = L.map('viewer', {
        center: [0, 0],
        crs: L.CRS.Simple,
        zoom: 2,
        zoomSnap: 0,
        zoomDelta: 0.25,
        maxBoundsViscosity: 1,
        doubleClickZoom: false
    });

    var tiles = L.tileLayer.iiif('https://stacks.stanford.edu/image/iiif/fh878gz0315%2F198_002_V_TC_46/info.json',
        {constrain: true});

    tiles.addTo(viewer);

    L.control.mousePosition().addTo(viewer);

    var FitWidth = L.Toolbar2.Action.extend({
        options: {
            toolbarIcon: {
                html: '<i class="fas fa-expand"></i>',
                tooltip: 'Fit width'
            }
        },
        addHooks: function(){
            tiles._fitWidth();
        }
    });
    var ViewFull = L.Toolbar2.Action.extend({
        options: {
            toolbarIcon: {
                html:'<i class ="fas fa-compress"></i>',
                tooltip: 'Fit image'
            }
        },
        addHooks: function(){
            tiles._fitBounds();
        }
    });


    /** Guides **/
    var ACTIVE_BUTTON_COLOR = 'dodgerblue';
    var drawingHorizontal = false;
    var drawingVertical = false;
    var HorizontalGuides = L.Toolbar2.Action.extend({
        options: {
            toolbarIcon: {
                html: '<i id="horizontalGuides" class="fas fa-ellipsis-h"></i>',
                tooltip: 'Place horizontal guides'
            }
        },
        addHooks: function(){
            drawingHorizontal = !drawingHorizontal;
            drawingVertical = false;
            if (drawingHorizontal) {
                $('#horizontalGuides').parent().css('background-color', ACTIVE_BUTTON_COLOR);
                $('#verticalGuides').parent().css('background-color', '');
            }
            else
                $('#horizontalGuides').parent().css('background-color', '');
        }
    });
    var VerticalGuides = L.Toolbar2.Action.extend({
        options: {
            toolbarIcon: {
                html:'<i id="verticalGuides" class="fas fa-ellipsis-v"></i>',
                tooltip: 'Place vertical guides'
            }
        },
        addHooks: function(){
            drawingHorizontal = false;
            drawingVertical = !drawingVertical;
            if (drawingVertical) {
                $('#verticalGuides').parent().css('background-color', ACTIVE_BUTTON_COLOR);
                $('#horizontalGuides').parent().css('background-color', '');
            }
            else
                $('#verticalGuides').parent().css('background-color', '');
        }
    });

    viewer.addControl(
        new L.Toolbar2.Control({
            actions: [FitWidth, ViewFull, HorizontalGuides, VerticalGuides],
            position: "topleft"
        }));

    // Add on click if drawing toggle is on
    viewer.on('singleclick', function(e){
        var location = e.latlng;
        var bounds = tiles._getBounds();

        //If within image bounds
        if (location.lat < 0 && location.lat > bounds._southWest.lat
            && location.lng > 0 && location.lng < bounds._northEast.lng){

            if (drawingVertical){
                drawVertical(e.latlng);
            } else if (drawingHorizontal) {
                drawHorizontal(e.latlng)
            }
        }
    });

    var linesV = [];
    function drawVertical(point){
        var height = tiles._getBounds()._southWest.lat;
        var latlngs = [
            [-height, point.lng],
            [height*2, point.lng]
        ];
        var polyline = L.polyline(latlngs, {color: 'red', weight:"2", draggable: true});
        polyline.on('dblclick ', function(e){
            console.log
            e.target.remove();
        });
        polyline.addTo(viewer);
        linesV.push(polyline._leaflet_id);
    }

    var linesH = [];
    function drawHorizontal(point){
        var width = tiles._getBounds()._northEast.lng;
        var latlngs = [
            [point.lat, -width],
            [point.lat, width*2]
        ];
        var polyline = L.polyline(latlngs, {color: 'blue', weight:"2", draggable: true, type:"line-h"});
        polyline.on('dblclick ', function(e){
            console.log
            e.target.remove();
        });
        polyline.addTo(viewer);
        linesH.push(polyline._leaflet_id);
    }

</script>
</body>
</html>