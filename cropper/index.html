<!DOCTYPE html>
<!-- Liz Fischer, 2016
github.com/lizfischer -->
<html lang="en">
<head>
	<title>IIIF Crop</title>
	<link rel="stylesheet" href="css/jquery.Jcrop.min.css">
	<link rel="stylesheet" href="css/main.css">
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery.Jcrop.min.js"></script>
	<script type="text/javascript" src="js/clipboard.min.js"></script>
	<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
</head>
<body>
	<h1>IIIF Image Cropper</h1>
	<p>A simple little tool to provide cropped <a href="iiif.io">IIIF</a> URLs. Input a valid IIIF image URL, then click and drag on the image to crop. </p>

	<label for="URL">Input URL:</label>
	<input type="text" id="URL" name="URL">
	<button type="button" id="submit">Load</button>

	<label for="ourput">Cropped URL:</label>
	<input type="text" name="output" id="output">

	<!-- Copy to clipboad -->
	<button class="btn" id="copy" data-clipboard-target="#output">
		<img src="assets/clippy.svg" alt="Copy to clipboard">
	</button>
	<script>
		(function(){
			new Clipboard('.btn');
		})();
	</script>




	<img style="display:none" src="" id="target">


	<script>
		var jcrop_api = null;
		$('#submit').click(loadImage);

		function loadImage(){
			if (jcrop_api != null){
				jcrop_api.destroy();
				$('#target').removeAttr('style');
			}
			var url = document.getElementById("URL").value;
			$('#target').attr("src", url);
			$('#target').Jcrop({
				boxHeight:700,
				onSelect: getURL,
				onChange: getURL,
				allowSelect: true,
				allowMove: true,
				allowResize: true
			}, function(){
				jcrop_api=this;
			});
		}

		// Get the new URL from JCrop coordinates
		function getURL(c){
			var oldURL = $('#target').attr('src');
			var split = oldURL.split('/');
			var sc = scaleCoords(c, oldURL); // scaled coordinates
			var tc = translateCoords(sc, oldURL);

			var coordStr = tc.x.toString() + ","+ tc.y.toString()+","+tc.w.toString()+","+tc.h.toString();
			split[split.length - 4] = coordStr;
			var newURL = split.join("/");
			$('#output').val(newURL);
		}

		// Adjusts for IIIF image scaling (pct:40, for example)
		function scaleCoords(c, url){
			var x = c.x;
			var y = c.y;
			var w = c.w;
			var h = c.h;
			var split = url.split('/');
			var pctStr = split[split.length-3];
			if (pctStr != "full"){
				var pct = pctStr.split(':')[1];
				var scale = 100/pct;
				x *= scale;
				y *= scale;
				w *= scale;
				h *= scale;
			}
			x = Math.round(x);
			y = Math.round(y);
			w = Math.round(w);
			h = Math.round(h);

			return {'x':x, 'y':y, 'w':w, 'h':h}
		}

		// Takes scaled coordinates
		function translateCoords(sc, oldURL){
			var x = parseInt(sc.x);
			var y = parseInt(sc.y);
			var w = parseInt(sc.w);
			var h = parseInt(sc.h);

			var oldCoords = oldURL.split('/')[oldURL.split('/').length - 4]

			if (oldCoords != "full"){
				var split = oldCoords.split(',');
				x += parseInt(split[0]);
				y += parseInt(split[1]);
			}
			return {'x':x, 'y':y, 'w':w, 'h':h}
		}

	</script>

</body>
</html>
